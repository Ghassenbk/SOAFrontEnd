<app-dashheader>
  <div>
    <h3 class="mb-4">Solutions</h3>

    <!-- FILTRES & TRI -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <!-- Recherche par nom -->
          <div class="col-md-3">
            <label class="form-label fw-bold text-dark">Rechercher par nom</label>
            <input type="text" class="form-control" [(ngModel)]="filterName" (input)="applyFilters()"
                   placeholder="Ex: Angular, Cloud...">
          </div>

          <!-- Filtre par prix -->
          <div class="col-md-3">
            <label class="form-label fw-bold text-dark">Prix max (€)</label>
            <input type="number" class="form-control" [(ngModel)]="filterMaxPrice" (input)="applyFilters()"
                   placeholder="Ex: 5000">
          </div>

          <!-- Tri par catégorie -->
          <div class="col-md-3">
            <label class="form-label fw-bold text-dark">Trier par catégorie</label>
            <select class="form-select" [(ngModel)]="sortCategory" (change)="applyFilters()">
              <option [ngValue]="null">Toutes les catégories</option>
              <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.nom }}</option>
            </select>
          </div>

          <!-- Tri par fournisseur & prix -->
          <div class="col-md-3">
            <label class="form-label fw-bold text-dark">Trier par</label>
            <select class="form-select" [(ngModel)]="sortBy" (change)="applyFilters()">
              <option value="name">Nom (A → Z)</option>
              <option value="price-asc">Prix croissant</option>
              <option value="price-desc">Prix décroissant</option>
              <option value="fournisseur">Fournisseur</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- LISTE DES SOLUTIONS -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="card-title m-0">Solutions ({{ filteredSolutions.length }})</h5>
          <button type="button" class="btn btn-dark shadow-none btn-sm"
                  data-bs-toggle="modal" data-bs-target="#solution-s"
                  (click)="resetNewSolution()">
            <i class="bi bi-plus-square"></i> Add
          </button>
        </div>

        <div class="table-responsive" style="height: 500px; overflow: auto;">
          <table class="table table-hover align-middle border">
            <thead class="table-dark sticky-top">
              <tr>
                <th>#</th>
                <th>Nom</th>
                <th>Description</th>
                <th>Prix</th>
                <th>Catégorie</th>
                <th>Fournisseur</th>
                <th>Image</th>
                <th>PDF</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let solution of filteredSolutions; let i = index">
                <td>{{ i + 1 }}</td>
                <td><strong>{{ solution.name }}</strong></td>
                <td>{{ solution.description || '—' }}</td>
                <td><span class="badge bg-success fs-6">{{ solution.prix | currency:'EUR' }}</span></td>

                <!-- BADGE CATÉGORIE AVEC COULEUR UNIQUE -->
                <td>
                  <span *ngIf="solution.categorie"
                        class="badge rounded-pill px-3 py-2"
                        [style.background-color]="getCategoryColor(solution.categorie.id)">
                    {{ solution.categorie.nom }}
                  </span>
                  <span *ngIf="!solution.categorie" class="text-muted">—</span>
                </td>

                <td>
                  <span class="badge bg-secondary">{{ solution.fournisseur?.nom || '—' }}</span>
                </td>

                <td>
                  <img [src]="getImageUrl(solution.image)"
                       alt="{{ solution.name }}"
                       class="border rounded shadow-sm"
                       style="width: 80px; height: 80px; object-fit: cover;">
                </td>

                <td>
                  <a [href]="'http://localhost:9090' + solution.devis" target="_blank"
                     class="text-danger">
                    <i class="bi bi-filetype-pdf" style="font-size: 28px;"></i>
                  </a>
                </td>

                <td>
                  <button class="btn btn-outline-primary btn-sm me-1"
                          data-bs-toggle="modal" data-bs-target="#Modifysolution-s"
                          (click)="editSolution(solution)">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm"
                          (click)="deleteSolution(solution.id)">
                    <i class="bi bi-trash3"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Si aucune solution -->
          <div *ngIf="filteredSolutions.length === 0" class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-1"></i>
            <p class="mt-3">Aucune solution trouvée avec ces filtres.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-dashheader>

<!-- ADD MODAL -->
<div class="modal fade" id="solution-s" tabindex="-1">
  <div class="modal-dialog">
    <form (ngSubmit)="addSolution()" #addForm="ngForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Solution</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

          <div class="mb-3">
            <label class="form-label">Name</label>
            <input [(ngModel)]="newSolution.name" name="name" type="text" class="form-control" required #name="ngModel">
            <div *ngIf="name.invalid && name.touched" class="text-danger">Name is required</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <input [(ngModel)]="newSolution.description" name="description" type="text" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Price (€)</label>
            <input [(ngModel)]="newSolution.prix" name="prix" type="number" min="0.01" step="0.01" class="form-control" required>
          </div>
          <!-- CATEGORIE -->
          <div class="mb-3">
            <label class="form-label">Catégorie</label>
            <select [(ngModel)]="newSolution.categorie" name="categorie" class="form-select" required>
              <option [ngValue]="null">Choisir une catégorie</option>
              <option *ngFor="let c of categories" [ngValue]="c">{{ c.nom }}</option>
            </select>
          </div>

          <!-- FOURNISSEUR -->
          <div class="mb-3">
            <label class="form-label">Fournisseur</label>
            <select [(ngModel)]="newSolution.fournisseur" name="fournisseur" class="form-select">
              <option [ngValue]="null">Aucun</option>
              <option *ngFor="let f of fournisseurs" [ngValue]="f">{{ f.nom }}</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Image</label>
            <input type="file" accept="image/*" (change)="onFileSelected($event)" class="form-control">
            <small *ngIf="selectedFile" class="text-success d-block mt-1">
              Selected: {{ selectedFile.name }}
            </small>
            <div *ngIf="!selectedFile && addForm.submitted" class="text-danger">Image is required</div>
          </div>

          <div class="mb-3">
            <label class="form-label">PDF File (Devis)</label>
            <input type="file" accept=".pdf" (change)="onPdfFileSelected($event)" class="form-control">
            <small *ngIf="selectedPdfFile" class="text-success d-block mt-1">
              Selected: {{ selectedPdfFile.name }}
            </small>
            <div *ngIf="!selectedPdfFile && addForm.submitted" class="text-danger">PDF is required</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-dark">Add Solution</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="Modifysolution-s" tabindex="-1">
  <div class="modal-dialog">
    <form (ngSubmit)="updateSolution()" #editForm="ngForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Solution</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

          <div class="mb-3">
            <label class="form-label">Name</label>
            <input [(ngModel)]="newSolution.name" name="name" type="text" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <input [(ngModel)]="newSolution.description" name="description" type="text" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Price (€)</label>
            <input [(ngModel)]="newSolution.prix" name="prix" type="number" min="0.01" step="0.01" class="form-control">
          </div>
          <!-- CATEGORIE -->
          <div class="mb-3">
            <label class="form-label">Catégorie</label>
            <select [(ngModel)]="newSolution.categorie" name="categorie" class="form-select" required>
              <option [ngValue]="null">Choisir une catégorie</option>
              <option *ngFor="let c of categories" [ngValue]="c">{{ c.nom }}</option>
            </select>
          </div>

          <!-- FOURNISSEUR -->
          <div class="mb-3">
            <label class="form-label">Fournisseur</label>
            <select [(ngModel)]="newSolution.fournisseur" name="fournisseur" class="form-select">
              <option [ngValue]="null">Aucun</option>
              <option *ngFor="let f of fournisseurs" [ngValue]="f">{{ f.nom }}</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Current Image</label><br>
            <!-- In edit modal -->
            <img [src]="getImageUrl(newSolution.image)"
                style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px;"
                class="border">
            <p class="mt-2"><strong>Change Image:</strong></p>
            <input type="file" accept="image/*" (change)="onFileSelected($event)" class="form-control">
            <small *ngIf="selectedFile" class="text-success d-block mt-1">New: {{ selectedFile.name }}</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Current PDF</label><br>
            <a [href]="'http://localhost:9090' + newSolution.devis" target="_blank">
              <i class="bi bi-filetype-pdf text-danger" style="font-size: 40px;"></i> Open Current PDF
            </a>
            <p class="mt-2"><strong>Change PDF:</strong></p>
            <input type="file" accept=".pdf" (change)="onPdfFileSelected($event)" class="form-control">
            <small *ngIf="selectedPdfFile" class="text-success d-block mt-1">New: {{ selectedPdfFile.name }}</small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-dark">Update Solution</button>
        </div>
      </div>
    </form>
  </div>
</div>